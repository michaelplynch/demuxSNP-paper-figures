---
title: "Figure-4-application"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Figure-4-application}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(demuxSNPpaperfigures)
library(CiteFuse)
```



````{r}

load("../data/sce_app.rda")

````


````{r}

library(scuttle)
df <- perCellQCMetrics(sce_app,
                       subsets=list(Mito=grep("^MT",rownames(sce_app))),
                       use_altexps=FALSE)
sce_app$lib_size<-df$sum
sce_app$percent_mito<-df$subsets_Mito_percent

````


````{r}
library(CiteFuse)
sce_app<-normaliseExprs(sce=sce_app,altExp_name = "HTO",transform="log")
sce_app<-crossSampleDoublets(sce_app)

library(Seurat)
seurat_app<-as.Seurat(sce_app,data=NULL)
seurat_app <- NormalizeData(seurat_app, assay = "HTO", normalization.method = "CLR")
seurat_app <- HTODemux(seurat_app, assay = "HTO", positive.quantile = 0.99)

table(seurat_app$hash.ID)
table(sce_app$doubletClassify_between_label,seurat_app$hash.ID)
#s2<-seurat_app[,seurat_app$nCount_RNA>1000 & seurat_app$percent_mito<10]
#s2<-HTODemux(s2, assay= "HTO")
#table(s2$hash.ID)
````



````{r}
df2<-as.data.frame(df[seurat_app$hash.ID=="Negative",])
library(ggpubr)
plots<-ggscatterhist(df2,x="sum",y="detected", title = "Quality metrics distributions for 'Negative' group") 
plots$sp <- plots$sp +
    geom_hline(yintercept = 1000, linetype = "dashed", color = "blue") +
  geom_vline(xintercept = 1500, linetype = "dashed", color = "red")
plots

high_qual<-df2$sum>1500 & df2$detected>750

table(high_qual)

barplot(table(high_qual))
````

 alluvial plots https://enblacar.github.io/SCpubr-book-v1/13-AlluvialPlot.html

````{r}



````


````{r fig.height=6,fig.width=15}
sample<-seurat_app
library(dplyr)
library(SCpubr)
p1 <- SCpubr::do_AlluvialPlot(sample = sample,
                            first_group = "hash.ID",
                            last_group = "doubletClassify_between_label",
                            flip=TRUE)



p1
table(seurat_app$hash.ID,seurat_app$doubletClassify_between_label)
````



````{r}
sce<-sce_app
altExp(sce,"HTO")<-as(altExp(sce,"HTO"), "SingleCellExperiment")
library(Matrix)
library(demuxSNP)
mat<-as.matrix(readMM('../data/v_outs_full.mtx'))
sce<-add_snps(sce,mat=mat)
sce<-high_conf_calls(sce)
sce<-reassign(sce)

sce$hash.ID<-seurat_app$hash.ID
soup<-read.table(file="../data/clusters.tsv", sep='\t',header=TRUE)
soup$assignment[soup$status=="doublet"]<-"Doublet"
soup$assignment[soup$status=="unassigned"]<-"unassigned"
sce$soup<-soup$assignment

table(sce$knn)
table(sce$hash.ID)
table(sce$soup)

table(sce$soup,sce$knn)

sce$soup_rc<-recode(sce$soup,
                    "0"="Hashtag1",
                    "1"="Hashtag5",
                    "2"="Hashtag6",
                    "3"="Hashtag3",
                    "4"="Hashtag4",
                    "5"="Hashtag2")

table(sce$soup_rc,sce$knn)
````




