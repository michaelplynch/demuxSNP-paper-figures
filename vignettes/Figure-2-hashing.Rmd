---
title: "Figure-2-hashing"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Figure-2-hashing}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(demuxSNPpaperfigures)
library(demuxSNP)
library(SingleCellExperiment)
library(Seurat)
library(demuxmix)
library(dittoSeq)
library(ggpubr)
library(gridExtra)

```

````{r}

source("../R/hto_sim.R")
source("../R/plot_hashtag.R")
````

# hashing based demultiplexing performance decreases with hashing quality:

## high qual 

````{r fig.width=12,fig.height=3}

mat<-logimat(6,nsinglet=rep(500,6), ndoub = 500, nneg=50)
size_sig=rep(10,6)
size_bg=rep(10,6)
mu_sig=rep(50,6)
mu_bg=rep(5,6)
counts<-draw_counts(size_sig = size_sig, size_bg = size_bg, mu_sig = mu_sig, mu_bg = mu_bg, mat = mat, seed = 1)

dim(counts)
truth<-colnames(counts)
df<-data.frame(t(counts))
plot<-plot_hashtag(df)
do.call(grid.arrange,c(plot,nrow=1))
````

## low qual

````{r fig.width=12,fig.height=3}

mat<-logimat(6,nsinglet=c(100,200,1000,400,500,800), ndoub = 500, nneg=50)
# size_sig=rep(10,6)
# size_bg=rep(20,6)
# mu_sig=rep(50,6)
# mu_bg=rep(5,6)
size_sig=rep(10,6)
size_bg=rep(7,6)
mu_sig=c(500,500,400,500,200,400)
mu_bg=c(110,120,90,100,60,80)
counts_low<-draw_counts(size_sig = size_sig, size_bg = size_bg, mu_sig = mu_sig, mu_bg = mu_bg, mat = mat, seed = 1)

dim(counts_low)
truth_low<-colnames(counts_low)
df<-data.frame(t(counts_low))
plot<-plot_hashtag(df,ylim=c(0,2000))
do.call(grid.arrange,c(plot,nrow=1))
````

````{r}

library(cellhashR)
colnames(counts)<-seq_len(dim(counts)[2])
chr<-GenerateCellHashingCalls(counts,
                              methods=c("htodemux","bff_raw","bff_cluster","dropletutils","multiseq"),
                              doTSNE = FALSE)

chr<-chr[order(as.numeric(chr$cellbarcode)),]
chr$gt<-truth

colnames(counts_low)<-seq_len(dim(counts_low)[2])
chr_low<-GenerateCellHashingCalls(counts_low,
                              methods=c("htodemux","bff_raw","bff_cluster","dropletutils","multiseq"),
                              doTSNE = FALSE)

chr_low<-chr_low[order(as.numeric(chr_low$cellbarcode)),]
chr_low$gt<-truth_low

library(caret)
methods=c("htodemux","bff_cluster","bff_raw")
df_full<-data.frame()
for (i in seq_along(methods)) {
  m<-methods[i]
  data_ch=chr[[m]]
  ref_ch=chr[['gt']]
  data_fac<-factor(data_ch,union(data_ch,ref_ch))
  ref_fac<-factor(ref_ch,union(data_ch,ref_ch))
  cf<-confusionMatrix(data=data_fac,reference=ref_fac)
  recall<-cf$byClass[,5]
  precision<-cf$byClass[,6]
  df<-data.frame(class=rownames(cf$byClass),data='high',method=m,precision=precision,recall=recall)
  df_full<-rbind(df_full,df)
}



for (i in seq_along(methods)) {
  m<-methods[i]
  data_ch=chr_low[[m]]
  ref_ch=chr_low[['gt']]
  data_fac<-factor(data_ch,union(data_ch,ref_ch))
  ref_fac<-factor(ref_ch,union(data_ch,ref_ch))
  cf<-confusionMatrix(data=data_fac,reference=ref_fac)
  recall<-cf$byClass[,5]
  precision<-cf$byClass[,6]
  df<-data.frame(class=rownames(cf$byClass),data='low',method=m,precision=precision,recall=recall)
  df_full<-rbind(df_full,df)
}


ggbarplot(df_full,x='method',y='recall', add = c("mean_se", "jitter"),color="data",position=position_dodge())
ggboxplot(df_full,x='method',y='recall', add = c("mean_se", "jitter"),color="data", label='class',label.select = list(top.down = 1))
````



````{r}

set.seed(2)
z<-matrix(0,nrow=6,ncol=dim(broad.sce.sim)[2])
for (i in 1:6) {
  names<-c("K1","K2","K3","K4","K5","K6")
  n<-names[i]
  z[i,broad.sce.sim$truth==n]<-1
  
}

nsinglet=as.vector(table(broad.sce.sim$truth[broad.sce.sim$truth!="Doublet"]))[1:6]
ngroups=6
ndoub=sum(broad.sce.sim$truth=="Doublet")
doub<-matrix(0,nrow=ngroups,ncol=ndoub)
  prob=proportions(nsinglet)
  ind<-replicate(n=ndoub,sample(seq_len(ngroups),size=2,prob=prob))
  for (j in seq_len(ndoub)) {
    doub[ind[,j],j]<-1
  }
z[,broad.sce.sim$truth=="Doublet"]<-doub

size_sig=rep(10,6)
size_bg=rep(7,6)
mu_sig=c(500,500,400,500,200,400)
mu_bg=c(110,120,90,100,60,80)

counts<-draw_counts(size_sig = size_sig, size_bg = size_bg, mu_sig = mu_sig, mu_bg = mu_bg, mat = z)

````




````{r}



````


## Misassigned cells generally fall between signal and background peak:

````{r}


````



## Combined hashing and SNPs approachs performs better than standalone hashing algorithms.


````{r}



````
